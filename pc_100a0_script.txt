
                # top stack elements is the start root, push it to altstack for later
                OP_TOALTSTACK
        
           a40001 # rd_val

           # build root
           
            # hash new leaf
            OP_SHA256 OP_TOALTSTACK

            # hash old leaf
            OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
        OP_FROMALTSTACK # new root from alt stack
        OP_SWAP

        OP_FROMALTSTACK # current element from alt stack
OP_DUP
        
        OP_SWAP OP_TOALTSTACK
OP_EQUALVERIFY # verify old root
        

    # new root on stack
    OP_TOALTSTACK

        a00001 # pc
        cc0001 # pc+imm

        # pc inclusion
        
            # hash new leaf
            OP_SHA256 OP_TOALTSTACK

            # hash old leaf
            OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
# Use merkle sibling together with new leaf on alt stack to find new merkle
# node and push it to the altstack.
OP_2DUP OP_DROP # duplicate sibling
OP_FROMALTSTACK # get new node from alt stack
OP_SWAP # swap direcion
        
OP_CAT OP_SHA256 OP_TOALTSTACK # combine to get new node to altstack
        
OP_SWAP # swap direcion
        
# Do the same with the current merkle leaf.
OP_CAT OP_SHA256
        
        OP_FROMALTSTACK # new root from alt stack
        OP_SWAP

        OP_FROMALTSTACK # current element from alt stack
OP_DUP
        
        OP_SWAP OP_TOALTSTACK
OP_EQUALVERIFY # verify old root
        
        
        OP_FROMALTSTACK OP_DROP

       # check input commitment
       OP_FROMALTSTACK
        OP_CAT
        OP_SHA256
        OP_0 # index
        OP_0 # nums key
        81 # current taptree
        OP_1 # flags, check input
        OP_CHECKCONTRACTVERIFY
         OP_1
